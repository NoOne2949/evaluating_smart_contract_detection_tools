import csv
import os

artifacts_file = "csvs/ZEUS_manually_tagged_unsafe_contracts_first_revise.csv"
vulnerability_file = "smartbugs-results/metadata/vulnerabilities_mapping_rev1.csv"
vulnerability_log = "vulnerabilities_log.csv"


def confronts_artifacts(artifact, contract_address, log_vulnerabilities):
    for row in artifact:
        address = row['Address']
        if address == contract_address:
            artifact_vulnerabilities = parse_vulnerabilities(row['Tag'])
            common_vulnerabilities, artifact_only, log_only = compare_vulnerabilities(artifact_vulnerabilities,
                                                                                      log_vulnerabilities)
            print(f"artifacts vulnerabilities: {row['Tag']}")
            print(f"log vulnerabilities: {log_vulnerabilities}")
            print("Comparison Results:")
            print("Common Vulnerabilities:", common_vulnerabilities)
            print("Artifacts Only:", artifact_only)
            print("Log Only:", log_only)
            print("\n")
    return None


def compare_vulnerabilities(artifact_vulnerabilities, log_vulnerabilities):
    common_vulnerabilities = []
    artifact_only = []
    log_only = []

    artifact_dict = {vul: line for line, vul in artifact_vulnerabilities}
    log_dict = {vul: line for line, vul in log_vulnerabilities}

    for line, vul in artifact_vulnerabilities:
        if vul not in log_dict or log_dict[vul] != line:
            artifact_only.append((line, vul))

    for line, vul in log_vulnerabilities:
        if vul in artifact_dict:
            if "-" in line:
                start, end = map(int, line.split('-'))
                artifact_line = int(artifact_dict[vul])
                if start <= artifact_line <= end:
                    common_vulnerabilities.append((line, vul))
                else:
                    log_only.append((line, vul))
            elif artifact_dict[vul] == line:
                common_vulnerabilities.append((line, vul))
            else:
                log_only.append((line, vul))
        else:
            log_only.append((line, vul))

    return common_vulnerabilities, artifact_only, log_only


def parse_vulnerabilities(vulnerability_string):
    vulnerabilities = []
    if vulnerability_string:
        for part in vulnerability_string.split(';'):
            if ': ' in part:
                vulnerability_line, vulnerability_name = part.split(': ')
                vulnerabilities.append((vulnerability_line.strip().lower(), vulnerability_name.strip().lower()))
    return vulnerabilities


def filter_vulnerabilities(mapping, headers, tool, row_vulnerabilities):
    vulnerabilities = []
    row_vulnerabilities = parse_vulnerabilities(row_vulnerabilities)

    for vulnerability in row_vulnerabilities:
        for row in mapping:
            if row[0] == tool and row[1] == vulnerability[1]:
                true_found = False
                for index, value in enumerate(row):
                    if value.strip().upper() == "TRUE":
                        true_found = True
                        if headers[index] == "Other" or headers[index] == "Ignore":
                            # print(f"{tool}:{vulnerability} discarded: has {headers[index]} class")
                            break
                        else:
                            vulnerabilities.append((vulnerability[0], headers[index]))
                            break
                if not true_found:
                    # print(f"{tool}:{vulnerability} discarded: vulnerability not tagged")
                    pass
                break
    return vulnerabilities


def extract_row_from_logs(artifacts):
    with open(vulnerability_file, 'r', newline='') as file:
        reader = csv.reader(file)
        headers = next(reader)
        mapping = list(reader)

    with open(vulnerability_log, 'r', newline='') as file:
        reader = csv.reader(file)
        for row in reader:
            if row[0] == "slither":
                vulnerabilities = filter_vulnerabilities(mapping, headers, row[0], row[2])
                confronts_artifacts(artifacts, row[1], vulnerabilities)
    return None


def confront_vulnerability():
    if not os.path.exists(vulnerability_log):
        print("Vulnerability log not found")
        return

    with open(artifacts_file, 'r', newline='') as infile:
        reader = csv.DictReader(infile)
        artifacts = list(reader)

    if artifacts:
        extract_row_from_logs(artifacts)
